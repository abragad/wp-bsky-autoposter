name: Release ZIP

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    name: Build Release ZIP
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, curl
      
      - name: Create build directory
        run: |
          mkdir -p build/wp-bsky-autoposter
      
      - name: Copy plugin files
        run: |
          set +e  # Don't exit on error for optional operations
          
          # Copy essential plugin files and directories
          # Copy directories that exist
          if [ -d includes ]; then
            cp -r includes build/wp-bsky-autoposter/
          fi
          if [ -d templates ]; then
            cp -r templates build/wp-bsky-autoposter/
          fi
          if [ -d assets ]; then
            cp -r assets build/wp-bsky-autoposter/
          fi
          if [ -d languages ]; then
            cp -r languages build/wp-bsky-autoposter/
          fi
          
          # Copy essential files
          cp wp-bsky-autoposter.php build/wp-bsky-autoposter/
          if [ -f README.md ]; then
            cp README.md build/wp-bsky-autoposter/
          fi
          if [ -f CHANGELOG.md ]; then
            cp CHANGELOG.md build/wp-bsky-autoposter/
          fi
          if [ -f LICENSE ]; then
            cp LICENSE build/wp-bsky-autoposter/
          fi
          
          set -e  # Re-enable exit on error
          
          # Remove files/directories listed in .distignore from build
          cd build/wp-bsky-autoposter
          if [ -f ../../.distignore ]; then
            set +e  # Don't exit on error for distignore processing
            while IFS= read -r line || [ -n "$line" ]; do
              # Skip empty lines and comments
              if [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]]; then
                continue
              fi
              # Remove leading slash if present and trim whitespace
              pattern=$(echo "$line" | sed 's|^/||' | xargs)
              # Remove the file/directory if it exists
              if [ -e "$pattern" ]; then
                rm -rf "$pattern" 2>/dev/null || true
              fi
            done < ../../.distignore
            set -e  # Re-enable exit on error
          fi
          
          # Ensure essential files are present
          if [ ! -f wp-bsky-autoposter.php ]; then
            echo "Error: wp-bsky-autoposter.php not found!"
            exit 1
          fi
      
      - name: Create ZIP file
        run: |
          cd build
          zip -r wp-bsky-autoposter-${{ steps.get_version.outputs.VERSION }}.zip wp-bsky-autoposter/ -x "*.DS_Store"
          cd ..
      
      - name: Verify ZIP contents
        run: |
          cd build
          echo "ZIP file size:"
          ls -lh wp-bsky-autoposter-${{ steps.get_version.outputs.VERSION }}.zip
          echo ""
          echo "ZIP contents (first 30 entries):"
          unzip -l wp-bsky-autoposter-${{ steps.get_version.outputs.VERSION }}.zip | head -30
          cd ..
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/wp-bsky-autoposter-${{ steps.get_version.outputs.VERSION }}.zip
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
